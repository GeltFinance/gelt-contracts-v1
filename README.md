[![Gelt logo](https://gelt.finance/img/logos/gelt.svg)](https://gelt.finance)

[![CI](https://github.com/GeltFinance/gelt-contracts-v1/actions/workflows/ci.yml/badge.svg)](https://github.com/GeltFinance/gelt-contracts-v1/actions/workflows/ci.yml)
[![License: AGPL v3](https://img.shields.io/badge/License-AGPL_v3-green.svg)](https://www.gnu.org/licenses/agpl-3.0)
![Version](https://img.shields.io/badge/Version-v1-blue)

# Gelt Contracts

This repository contains all the smart contracts and tests relevant to the DeFi backend of Gelt High-Yield Savings.

The `main` branch contains the tested, audited and deployed contracts on the Polygon Mainnet.

| Contract      | Address                                                                                                                    |
|---------------|----------------------------------------------------------------------------------------------------------------------------|
| Gelt Vault V1 | [`0xEFB9905770Efa60D0f5A49340c55DaDb2cD09a8B`](https://polygonscan.com/address/0xEFB9905770Efa60D0f5A49340c55DaDb2cD09a8B) |

## Overview

[Gelt High-Yield Savings](https://gelt.finance/) is a DeFi savings product built on Ethereum L1/Polygon that offers user-friendly access to vetted, high-yield decentralized finance (DeFi) protocols. More specifically, Gelt enables users to deposit and withdraw funds directly from their bank accounts into mStable, a stablecoin swap protocol, while providing automatic deposit cover through [Nexus Mutual](https://nexusmutual.io/).

As Gelt High-Yield Savings is non-custodial, users maintain exclusive control of their funds through their private keys. No one at Gelt, nor anyone else, can access users' accounts.

### Yield Generation

[mStable](https://mstable.org/) is a decentralized protocol wherein users engage in swaps between different stablecoins or supply liquidity in exchange for a portion of protocol revenue. Gelt yields are generated by supplying USD Coin (USDC) to mStable and through over-collateralized lending on third-party lending platforms (Aave and Compound) integrated with mStable.

## Repository Structure

| Folder          | Purpose                                                                                                                                                                                                                                           |
|-----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `contracts/`    | Solidity contracts and interfaces for the Gelt Vault.                                                                                                                                                                                             |
|  `lib/`         | Supporting libraries (e.g. fixed-point math).                                                                                                                                                                                                     |
|  `interface/`   | Interfaces for the Vault and the protocols it interacts with.                                                                                                                                                                                     |
|  `harness/`     | Contracts used by the test suites.                                                                                                                                                                                                                |
| `docs/`         | Diagrams and documentation for the Gelt Vault and ancillary services.                                                                                                                                                                             |
| `tests/`        | BDD-style test suites.                                                                                                                                                                                                                            |
|  `unit/`        | Unit tests running against a local network.                                                                                                                                                                                                       |
|  `scenario/`    | Scenario tests simulating Vault interactions running against a local network.                                                                                                                                                                     |
|  `integration/` | Integration tests running against a forked network.                                                                                                                                                                                               |
|  `functional/`  | Functional tests defined using Gherkin syntax running against a forked network.                                                                                                                                                                   |
| `patches/`      | Patch for `@openzeppelin/upgrades-core:1.11.0` adding preliminary support for [user-defined value types](https://blog.soliditylang.org/2021/09/27/user-defined-value-types/#:~:text=Solidity%20v0.,type%20safety%20and%20improves%20readability). |

## Security

Most functions on the Gelt Vault are access controlled as they're meant to be called by the Gelt Relayer which allows for gasless interaction via meta-transactions.

One notable exception is the `voluntaryExit(..)` function which allows for withdrawal independent of the Gelt Relayer. Using this function the caller pays for any transaction and mStable redemption fees.

The access control policies of the Gelt Vault were designed with the principles of least privilege and separation of duties in mind. The following roles exist on the Gelt Vault:

| Role          | Allowed operations                                                                                                                                        |
|:--------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| Owner         | Upgrade the Vault smart contract, grant and revoke Administrator and Operator roles                                                                       |
| Administrator | Configure, temporarily pause and unpause the Vault, emergency exit strategy, sweep unprotected tokens from the Vault                                      |
| Operator      | Submit mint and redeem meta-transactions, deposit and withdraw from the strategy (mStable), collect governance tokens to the configured collector address |


Gelt uses multi-signature wallets to protect the Owner and Administrator keys. The policies also define that there can only be a single Owner at any given time.

### Audit & Bug Bounty

Gelt's smart contracts have been audited by Quantstamp.
The full audit report is made available on [Quantstamp's certification website](https://certificate.quantstamp.com/full/gelt-vault-v-1).

Gelt also has an active bug bounty for smart contract vulnerabilities which can lead to a substantial loss or irreversible freezing of user funds.
For more details please see our [bug bounty page on Immunefi](https://immunefi.com/bounty/gelt/).

## Development

### Prerequisites

- Node.js v16.13.0 LTS or later

### Installing Dependencies

```shell
npm install
```

### Running Tests

The contracts are tested using unit, scenario, integration and functional test suites.

All unit and scenario tests are executed against contracts deployed on a blank local network, while integration and functional
tests are run against a local fork of the Polygon Mainnet allowing the tests and the Gelt Vault to interact with deployed protocols, such as [mStable](https://mstable.org/).

#### Configuration

As integration and functional tests rely on a forked state of the Polygon Mainnet, in order to run these tests,
a valid Alchemy access token must be specified using the `ALCHEMY_ACCESS_TOKEN` environment variable in the [`.env`](.env) file.

#### Running all tests suites

```shell
npm test
```

#### Running individual test suites

To run unit tests:

```shell 
npm run test:unit
```

To run scenario tests:

```shell 
npm run test:scenario
```

To run integration tests (requires Alchemy access token present in [`.env`](.env)):

```shell 
npm run test:integration
```

To run functional tests (requires Alchemy access token present in [`.env`](.env)):

```shell
npm run test:functional
```

### Generating documentation

Solidity contracts are annotated with NatSpec comments which provide rich documentation for functions, return variables and more.

These can be turned into a documentation by running

```shell
npm run docgen 
```

The resulting documentation will be available in the [`docs/contracts/`](docs/contracts) folder. 
